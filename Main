#include <iostream>
#include <string>
#include <fstream>
#include <iomanip>
#include <sstream> 
using namespace std;

struct StudProf {
    string id;
    string name;
    string birthday;
    string address;
    string gender;
    string degreeProgram;
    int yearLevel;
};

struct Node {
    StudProf profile;
    Node *next;
};

Node *head = nullptr;

void loadDataFromFile(fstream &file) {
    file.open("student.txt", ios::in);
    if (!file) {
        cout << "Error opening file.\n";
        return;
    }
    
    string line;
    while (getline(file, line)) {
        stringstream ss(line);
        StudProf newStudent;
        string temp;
        
        getline(ss, newStudent.id, ',');
        getline(ss, newStudent.name, ',');
        getline(ss, newStudent.birthday, ',');
        getline(ss, newStudent.address, ',');
        getline(ss, newStudent.gender, ',');
        getline(ss, newStudent.degreeProgram, ',');
        getline(ss, temp, ',');
        newStudent.yearLevel = stoi(temp);
        
        Node *newNode = new Node;
        newNode->profile = newStudent;
        newNode->next = head;
        head = newNode;
    }
    file.close();
}

void studName(const StudProf& profile) {
    Node *newNode = new Node;
    newNode->profile = profile;
    newNode->next = head;
    head = newNode;
}

void saveToFile() {
    // Open the file for writing. If it exists, it will be overwritten.
    ofstream file("students.txt");
    if (!file) {
        cout << "Error opening file for saving.\n";
        return;
    }

    // Write each student's data to the file
    Node *current = head;
    while (current != nullptr) {
        file << current->profile.id << ","
             << current->profile.name << ","
             << current->profile.birthday << ","
             << current->profile.address << ","
             << current->profile.gender << ","
             << current->profile.degreeProgram << ","
             << current->profile.yearLevel << "\n";
        current = current->next;
    }

    file.close(); // Close the file
    cout << "Records saved to file successfully.\n";
}

void displayMenu() {
    int userInput;
    cout << "Welcome to Group Pr0gr@mm@z Student Information System\n";
    cout << "-----------------------------------------\n";
    cout << "What do you want to do?\n";
    cout << "-----------------------------------------\n";
    cout << "1. Add Records\n";
    cout << "2. Search Records\n";
    cout << "3. Display All Records\n";
    cout << "4. Display Specific Records\n";
    cout << "5. Delete Record\n";
    cout << "6. Exit\n";
    cout << "-----------------------------------------\n";
    cout << "Please Type Your Selection:\n";
    cout << "-----------------------------------------\n";
}

void addRecords(){
    StudProf newStudent;
    cout << "Enter Student ID: ";
    cin >> newStudent.id;
    cin.ignore();

    cout << "Enter Full Name: ";
    getline(cin, newStudent.name);

    cout << "Enter Birthday (YYYY|MM|DD): ";
    getline(cin, newStudent.birthday);

    cout << "Enter Address: ";
    getline(cin, newStudent.address);

    cout << "Enter Gender: ";
    getline(cin, newStudent.gender);

    cout << "Enter Degree Program (e.g Bachelor of Science in Computer Science): ";
    getline(cin, newStudent.degreeProgram);

    cout << "Enter Year Level: ";
    cin >> newStudent.yearLevel; //ginawa kong cin kasi integer datatype lang naman [shaun]
    cin.ignore(); //para maclear natin para sa next input kemi [shaun]

    studName(newStudent); //add nating yung student sa 
    saveToFile(); 
    cout << "Record Added Successfully!\n";
}

void searchRecords(fstream &file) {
    string id;
    cout << "Enter Student ID: ";
    cin.ignore();
    getline(cin, id);

    Node *current = head;
    while (current != nullptr) {
        if (current->profile.id == id) {
            cout << "Student Found:\n";
            cout << "ID: " << current->profile.id << "\n";
            cout << "Name: " << current->profile.name << "\n";
            cout << "Birthday: " << current->profile.birthday << "\n";
            cout << "Address: " << current->profile.address << "\n";
            cout << "Gender: " << current->profile.gender << "\n";
            cout << "Degree Program: " << current->profile.degreeProgram << "\n";
            cout << "Year Level: " << current->profile.yearLevel << "\n";
            return;
        }
        current = current->next;
    }
    cout << "Student record not found.\n";
}

void displayRecords() {
    cout << left << setw(12) << "ID"
         << setw(30) << "Name"
         << setw(15) << "Birthday"
         << setw(30) << "Address"
         << setw(10) << "Gender"
         << setw(30) << "Degree Program"
         << setw(12) << "Year Level" << endl;

    cout << string(12, '-') << " "
         << string(30, '-') << " "
         << string(15, '-') << " "
         << string(30, '-') << " "
         << string(10, '-') << " "
         << string(30, '-') << " "
         << string(12, '-') << endl;

    Node *current = head;
    while (current != nullptr) {
        cout << left << setw(12) << current->profile.id
             << setw(30) << current->profile.name
             << setw(15) << current->profile.birthday
             << setw(30) << current->profile.address
             << setw(10) << current->profile.gender
             << setw(30) << current->profile.degreeProgram
             << setw(12) << current->profile.yearLevel << endl;

        current = current->next; 
    }
}

void displaySpecificRecord() {
    string id;
    cout << "Enter Student ID to search: ";
    cin.ignore();
    getline(cin, id);

    Node *current = head;
    bool found = false;

    while (current != nullptr) {
        if (current->profile.id == id) {
            cout << "Student Found:\n";
            cout << "ID: " << current->profile.id << "\n";
            cout << "Name: " << current->profile.name << "\n";
            cout << "Birthday: " << current->profile.birthday << "\n";
            cout << "Address: " << current->profile.address << "\n";
            cout << "Gender: " << current->profile.gender << "\n";
            cout << "Degree Program: " << current->profile.degreeProgram << "\n";
            cout << "Year Level: " << current->profile.yearLevel << "\n";
            found = true;
            break;
        }
        current = current->next;
    }

    if (!found) {
        cout << "No student found with ID: " << id << endl;
    }
}

void deleteRecords(fstream &file) {
    string id;
    cout << "Input an ID Number to delete: ";
    cin.ignore();
    getline(cin, id);

    Node *current = head;
    Node *previous = nullptr;

    while (current != nullptr) {
        if (current->profile.id == id) {
            if (previous == nullptr) {
                head = current->next;
            } else {
                previous->next = current->next;
            }
            delete current;
            cout << "Record with ID " << id << " deleted successfully.\n";
            return;
        }
        previous = current;
        current = current->next;
    }

    cout << "Record with ID " << id << " not found.\n";
}

void exitProgram() {
    cout << "Thank you for using Group# Student Portal\n";
    cout << "Group Members:\n";
    cout << "-----------------------------------------\n";
    cout << "1. Azarraga, Dwayne Antoine Benjamin C.\n";
    cout << "2. Eleptico, Genesis Rilly C.\n";
    cout << "3. Pascual, Shaun Robert T.\n";
    cout << "4. Soriano, Jermaine Rikko C.\n";
    cout << "-----------------------------------------\n";
}

int main() {
    fstream file;
    loadDataFromFile(file);

    int choice = 0;

    while (true) {
        displayMenu();
        if (!(cin >> choice)) {
            cin.clear();
            cin.ignore();
            cout << "Invalid input. Please enter a valid choice.\n";
            continue;
        }

        switch (choice) {
            case 1: addRecords(); break;
            case 2: searchRecords(file); break;
            case 3: displayRecords(); break;
            case 4: displaySpecificRecord(); break;
            case 5: deleteRecords(file); break;
            case 6:
                exitProgram();
                file.close();
                return 0;
            default:
                cout << "Invalid choice, please try again." << endl;
        }
    }

    file.close();
    exitProgram();
    return 0;
}